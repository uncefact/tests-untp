name: Build and Test

on:
  pull_request:
    branches:
      - next

jobs:
  test_and_build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      # https://github.com/actions/runner-images/issues/2840#issuecomment-1284059930
      # https://github.com/uncefact/tests-untp/issues/344
      - name: Free up space on ubuntu runner for E2E tests
        run: |
          sudo rm -rf \
            "$AGENT_TOOLSDIRECTORY" \
            /opt/google/chrome \
            /opt/microsoft \
            /opt/pipx \
            /usr/local/.ghcup \
            /usr/local/graalvm* \
            /usr/local/julia* \
            /usr/local/lib/android \
            /usr/local/share/chromium \
            /usr/local/share/powershell \
            /usr/local/share/vcpkg \
            /usr/share/dotnet \
            /usr/share/miniconda \
            /usr/share/swift
          docker image prune -af

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      - name: Build E2E images with layer cache
        run: |
          docker buildx bake -f docker-compose.e2e.yml \
            --set "*.cache-from=type=gha" \
            --set "*.cache-to=type=gha,mode=max" \
            --load

      - name: Start E2E docker compose
        run: SEEDING=true docker compose -f docker-compose.e2e.yml up -d --no-build

      - name: Stop docker compose
        run: docker compose -f docker-compose.e2e.yml down
