generator client {
  provider      = "prisma-client-js"
  output        = "../src/lib/prisma/generated"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("RI_DATABASE_URL")
}

enum DidType {
  DEFAULT
  MANAGED
  SELF_MANAGED
}

enum DidMethod {
  DID_WEB
  DID_WEB_VH
}

enum DidStatus {
  ACTIVE
  INACTIVE
  VERIFIED
  UNVERIFIED
}

enum ServiceType {
  DID
}

enum AdapterType {
  VCKIT
}

/**
 * Auth.js + Prisma adapter tables for OAuth + JWT sessions
 */
model User {
  id              String    @id @default(cuid())
  authProviderId  String?   @unique
  name            String?
  email           String?   @unique
  emailVerified   DateTime?
  image           String?
  tenantId        String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  accounts     Account[]
  tenant       Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  access_token      String?
  refresh_token     String?
  expires_at        Int?
  id_token          String?
  token_type        String?
  scope             String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Tenant {
  id             String   @id @default(cuid())
  name           String
  primaryColor   String?
  secondaryColor String?
  logo           String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  users            User[]
  dids             Did[]
  serviceInstances ServiceInstance[]

  @@map("Tenant")
}

/**
 * Stores issued verifiable credentials metadata
 */
model Credential {
  id             String   @id @default(cuid())
  storageUri     String
  hash           String
  decryptionKey  String?
  credentialType String
  isPublished    Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

/**
 * DID records scoped to organisations (tenants).
 * Supports three tiers: DEFAULT (system-wide), MANAGED, and SELF_MANAGED.
 */
model Did {
  id             String    @id @default(cuid())
  tenantId       String
  did            String    @unique
  type           DidType
  method         DidMethod @default(DID_WEB)
  name           String
  description    String?
  keyId          String
  status         DidStatus @default(UNVERIFIED)
  isDefault      Boolean   @default(false)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  serviceInstanceId String?
  serviceInstance   ServiceInstance? @relation(fields: [serviceInstanceId], references: [id], onDelete: SetNull)

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

/**
 * Registered service instances scoped to organisations (tenants).
 * Each instance stores AES-256-GCM encrypted configuration for its adapter.
 */
model ServiceInstance {
  id             String       @id @default(cuid())
  tenantId       String
  serviceType    ServiceType
  adapterType    AdapterType
  name           String
  description    String?
  config         String       // AES-256-GCM encrypted JSON blob
  apiVersion     String       // Semver without v prefix, e.g. "1.1.0"
  isPrimary      Boolean      @default(false)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  tenant         Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  dids           Did[]

  @@index([tenantId, serviceType])
}
