<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UNTP Test Suite - Browser Testing</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }

      .container {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      h1 {
        color: #2c3e50;
        border-bottom: 3px solid #3498db;
        padding-bottom: 10px;
      }

      .upload-section {
        border: 2px dashed #3498db;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
        margin: 20px 0;
        background-color: #f8f9fa;
      }

      .upload-section.dragover {
        border-color: #27ae60;
        background-color: #e8f5e8;
      }

      #credentialFiles {
        margin: 10px 0;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 100%;
        max-width: 400px;
      }

      .file-list {
        margin: 15px 0;
        text-align: left;
      }

      .file-item {
        background: #ecf0f1;
        padding: 8px 12px;
        margin: 5px 0;
        border-radius: 4px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .file-remove {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 2px 8px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
      }

      .controls {
        margin: 20px 0;
      }

      .tag-input {
        margin: 10px 0;
      }

      .tag-input input {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-right: 5px;
      }

      .tag-list {
        margin: 10px 0;
      }

      .tag {
        display: inline-block;
        background: #3498db;
        color: white;
        padding: 4px 8px;
        margin: 2px;
        border-radius: 12px;
        font-size: 12px;
      }

      .tag .remove {
        margin-left: 5px;
        cursor: pointer;
        font-weight: bold;
      }

      button {
        background: #3498db;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        margin: 5px;
      }

      button:hover {
        background: #2980b9;
      }

      button:disabled {
        background: #bdc3c7;
        cursor: not-allowed;
      }

      .results {
        background: #2c3e50;
        color: #ecf0f1;
        padding: 20px;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        font-size: 14px;
        max-height: 400px;
        overflow-y: auto;
        margin-top: 20px;
      }

      .results ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .results .suite-title {
        font-weight: bold;
        margin: 10px 0 5px 0;
        color: #ecf0f1;
      }

      .results .test-pass {
        color: #2ecc71;
        margin: 2px 0;
        padding-left: 20px;
      }

      .results .test-fail {
        color: #e74c3c;
        margin: 2px 0;
        padding-left: 20px;
      }

      .results .test-pending {
        color: #f39c12;
        margin: 2px 0;
        padding-left: 20px;
      }

      .results .test-error {
        color: #e74c3c;
        font-size: 12px;
        padding-left: 40px;
        margin: 2px 0;
      }

      .results .summary {
        margin-top: 15px;
        padding-top: 10px;
        border-top: 1px solid #34495e;
      }

      .status {
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        font-weight: bold;
      }

      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .status.running {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>UNTP Test Suite - Browser Testing</h1>
      <p>Upload UNTP credential files (.json) to test them against the built-in validation suites.</p>

      <div class="upload-section" id="uploadSection">
        <h3>üìÅ Upload Credential Files</h3>
        <p>Drag and drop JSON credential files here, or click to select files</p>
        <input type="file" id="credentialFiles" accept=".json,application/json" multiple />
        <div class="file-list" id="fileList"></div>
      </div>

      <div class="controls">
        <details style="margin-bottom: 20px">
          <summary style="cursor: pointer; font-weight: bold; font-size: 16px">
            üìã Extension Schema Mappings (Optional)
          </summary>
          <div style="margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9">
            <p>Upload JSON schema mapping files for custom credential extensions:</p>
            <input type="file" id="extensionMappingFiles" accept=".json,application/json" multiple />
            <div style="margin-top: 8px; font-size: 12px; color: #666">
              Expected format:
              <code>{"version": "0.1.0", "mappings": [{"credentialType": "...", "schemaUrlPattern": "..."}]}</code>
            </div>
            <div id="extensionFileList" style="margin-top: 10px"></div>
          </div>
        </details>

        <h3>üè∑Ô∏è Test Filtering (Optional)</h3>
        <div class="tag-input">
          <input type="text" id="tagInput" placeholder="Enter tag name (e.g., tier1, smoke, validation)" />
          <button onclick="addTag()">Add Tag</button>
        </div>
        <div class="tag-list" id="tagList"></div>

        <h3> Trusted DIDs (Optional)</h3>
        <div class="tag-input">
          <input type="text" id="trustedDIDInput" placeholder="Enter DID" />
          <button onclick="addTrustedDID()">Add DID</button>
        </div>
        <div class="tag-list" id="trustedDIDList"></div>

        <div style="margin-top: 20px">
          <button id="runTestsBtn" onclick="runTests()" disabled>üöÄ Run Tests</button>
          <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
        </div>
      </div>

      <div id="status"></div>
      <div id="results" class="results" style="display: none"></div>
    </div>

    <!-- Hidden div for Mocha's default output (prevents warnings) -->
    <div id="mocha" style="display: none"></div>

    <!-- Load Mocha and dependencies -->
    <script src="https://unpkg.com/mocha@10.2.0/mocha.js"></script>
    <script src="https://unpkg.com/chai@4.3.10/chai.js"></script>

    <!-- Load AJV for JSON schema validation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/8.17.1/ajv2020.bundle.min.js"></script>

    <!-- Load JSON-LD for JSON-LD validation -->
    <script src="https://unpkg.com/jsonld@8/dist/jsonld.min.js"></script>

    <script src="https://eyereasoner.github.io/eye-js/18/latest/index.js"></script>

    <!-- Initialize Mocha for browser -->
    <script>
      // Set up Mocha for browser environment
      mocha.setup('bdd');
    </script>

    <!-- Load our test files (these will be bundled or served statically) -->
    <script src="browser-bundle.js"></script>

    <script>
      // Global state
      let selectedFiles = [];
      let selectedTags = [];
      let trustedDIDs = [];
      let extensionMappingFiles = [];
      let isRunning = false;

      // File upload handling
      const fileInput = document.getElementById('credentialFiles');
      const fileList = document.getElementById('fileList');
      const uploadSection = document.getElementById('uploadSection');
      const runTestsBtn = document.getElementById('runTestsBtn');
      const extensionFileInput = document.getElementById('extensionMappingFiles');
      const extensionFileList = document.getElementById('extensionFileList');

      // Drag and drop handlers
      uploadSection.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadSection.classList.add('dragover');
      });

      uploadSection.addEventListener('dragleave', () => {
        uploadSection.classList.remove('dragover');
      });

      uploadSection.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadSection.classList.remove('dragover');
        handleFiles(e.dataTransfer.files);
      });

      // File input change handler
      fileInput.addEventListener('change', (e) => {
        handleFiles(e.target.files);
      });

      // Extension mapping file input change handler
      extensionFileInput.addEventListener('change', handleExtensionFiles);

      // Handle selected files
      function handleFiles(files) {
        for (let file of files) {
          if (file.type === 'application/json' || file.name.endsWith('.json')) {
            selectedFiles.push(file);
          }
        }
        updateFileList();
        updateRunButton();
      }

      // Update file list display
      function updateFileList() {
        fileList.innerHTML = '';
        selectedFiles.forEach((file, index) => {
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';
          fileItem.innerHTML = `
                    <span>üìÑ ${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>
                    <button class="file-remove" onclick="removeFile(${index})">‚úï</button>
                `;
          fileList.appendChild(fileItem);
        });
      }

      // Remove file from selection
      function removeFile(index) {
        selectedFiles.splice(index, 1);
        updateFileList();
        updateRunButton();
      }


      // Trusted DIDs
      function addTrustedDID() {
        const did = document.getElementById('trustedDIDInput').value.trim();
        if (did && !trustedDIDs.includes(did)) {
          trustedDIDs.push(did);
          updateTrustedDIDsList();
          document.getElementById('trustedDIDInput').value = '';
        }
      }

      function removeTrustedDID(did) {
        trustedDIDs = trustedDIDs.filter((t) => t !== did);
        updateTrustedDIDsList();
      }

      function updateTrustedDIDsList() {
        document.getElementById('trustedDIDList').innerHTML = '';
        trustedDIDs.forEach((did) => {
          const didSpan = document.createElement('span');
          didSpan.className = 'tag';
          didSpan.innerHTML = `${did} <span class="remove" onclick="removeTrustedDID('${did}')">‚úï</span>`;
          document.getElementById('trustedDIDList').appendChild(didSpan);
        });
      }

      // Tag management
      function addTag() {
        const tagInput = document.getElementById('tagInput');
        const tag = tagInput.value.trim();
        if (tag && !selectedTags.includes(tag)) {
          selectedTags.push(tag);
          updateTagList();
          tagInput.value = '';
        }
      }

      function removeTag(tag) {
        selectedTags = selectedTags.filter((t) => t !== tag);
        updateTagList();
      }

      function updateTagList() {
        const tagList = document.getElementById('tagList');
        tagList.innerHTML = '';
        selectedTags.forEach((tag) => {
          const tagSpan = document.createElement('span');
          tagSpan.className = 'tag';
          tagSpan.innerHTML = `${tag} <span class="remove" onclick="removeTag('${tag}')">‚úï</span>`;
          tagList.appendChild(tagSpan);
        });
      }

      // Enable/disable run button
      function updateRunButton() {
        runTestsBtn.disabled = selectedFiles.length === 0 || isRunning;
      }

      // Tag input enter key support
      document.getElementById('tagInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          addTag();
        }
      });

      // Status display
      function showStatus(message, type = 'info') {
        const status = document.getElementById('status');
        status.className = `status ${type}`;
        status.textContent = message;
        status.style.display = 'block';
      }

      function hideStatus() {
        document.getElementById('status').style.display = 'none';
      }

      // Results display
      function showResults() {
        document.getElementById('results').style.display = 'block';
      }

      function appendResult(text, className = '', indentLevel = 0) {
        const results = document.getElementById('results');
        const div = document.createElement('div');
        if (className) {
          div.className = className;
        }

        // Always use HTML for error messages, textContent for others
        if (className === 'test-error') {
          div.innerHTML = formatErrorForHtml(text);
        } else {
          div.textContent = text;
        }

        div.style.paddingLeft = `${indentLevel * 20}px`;
        results.appendChild(div);
        results.scrollTop = results.scrollHeight;
      }

      function formatErrorForHtml(errorMessage) {
        // Escape HTML characters using browser's built-in escaping
        const div = document.createElement('div');
        div.textContent = errorMessage;
        const escaped = div.innerHTML;

        // Convert newlines to HTML breaks and preserve indentation
        return escaped.replace(/\n/g, '<br>').replace(/ {6}/g, '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;');
      }

      function clearResults() {
        document.getElementById('results').innerHTML = '';
        document.getElementById('results').style.display = 'none';
      }

      function handleExtensionFiles(event) {
        const files = Array.from(event.target.files);
        extensionMappingFiles = files;
        updateExtensionFileList();
      }

      function updateExtensionFileList() {
        const container = extensionFileList;
        container.innerHTML = '';

        if (extensionMappingFiles.length === 0) {
          return;
        }

        extensionMappingFiles.forEach((file, index) => {
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item';
          fileItem.innerHTML = `
            <span>üìÑ ${file.name}</span>
            <button class="file-remove" onclick="removeExtensionFile(${index})">‚ùå</button>
          `;
          container.appendChild(fileItem);
        });
      }

      function removeExtensionFile(index) {
        extensionMappingFiles.splice(index, 1);
        updateExtensionFileList();
      }

      async function getExtensionMappings() {
        if (extensionMappingFiles.length === 0) {
          return []; // No extension mappings provided
        }

        const mappings = [];

        for (const file of extensionMappingFiles) {
          try {
            const content = await file.text();
            const parsed = JSON.parse(content);
            mappings.push(parsed);
          } catch (error) {
            showStatus(`Invalid JSON in extension mapping file "${file.name}": ${error.message}`, 'error');
            return []; // Return empty on any error
          }
        }

        return mappings;
      }

      // Main test execution function
      async function runTests() {
        if (selectedFiles.length === 0) {
          showStatus('Please select at least one credential file', 'error');
          return;
        }

        isRunning = true;
        updateRunButton();

        // Track displayed suites to show proper hierarchy
        const displayedSuites = new Set();

        try {
          showStatus('Running tests...', 'running');

          // Clear previous results and show the results div
          document.getElementById('results').innerHTML = '';
          showResults();

          appendResult('üìÅ Files: ' + selectedFiles.map((f) => f.name).join(', '));

          if (selectedTags.length > 0) {
            appendResult('üè∑Ô∏è  Tags: ' + selectedTags.join(', '));
          }

          appendResult('');

          // Read credential files and set credential state
          const credentialData = new Map();

          for (const file of selectedFiles) {
            try {
              const content = await file.text();
              const fileName = file.name;

              // Validate JSON format
              JSON.parse(content);

              credentialData.set(fileName, content);
            } catch (error) {
              appendResult(`‚ùå Skipping invalid JSON file ${file.name}: ${error.message}`);
            }
          }

          if (credentialData.size === 0) {
            throw new Error('No valid JSON credential files found');
          }

          // Set credential data for tests
          if (typeof window.untpTestSuite.setCredentialData === 'undefined') {
            throw new Error(
              'Credential state functions not loaded. Please ensure the browser bundle is built correctly.',
            );
          }
          window.untpTestSuite.setCredentialData(credentialData);

          window.untpTestSuite.trustedDIDs.length = 0;
          window.untpTestSuite.trustedDIDs.push(...trustedDIDs);

          // Check if UNTPTestRunner is available
          if (typeof window.untpTestSuite.UNTPTestRunner === 'undefined') {
            throw new Error('UNTPTestRunner not loaded. Please ensure the browser bundle is built correctly.');
          }

          // Run tests using UNTPTestRunner
          const runner = new window.untpTestSuite.UNTPTestRunner();
          const extensionMappings = await getExtensionMappings();

          // Debug what we're passing
          console.log('Extension mappings being passed:', extensionMappings);

          const results = await runner.run(
            {
              tags: selectedTags.length > 0 ? selectedTags : undefined,
              extensionSchemaMaps: extensionMappings,
              mochaSetupCallback: (mochaOptions) => {
                // Create fresh Mocha instance like CLI does
                if (typeof window.Mocha === 'undefined') {
                  throw new Error('Mocha constructor not found. Ensure Mocha script is loaded.');
                }

                // Create new Mocha instance with options (like CLI)
                const freshMocha = new window.Mocha(mochaOptions);

                // Set up BDD interface globals (describe, it, before, etc.)
                freshMocha.suite.emit('pre-require', window, null, freshMocha);

                // Execute registered test suites after fresh Mocha is set up
                // Execute registered test suites after credentials are loaded
                if (typeof window.untpTestSuite.executeRegisteredTestSuites === 'function') {
                  window.untpTestSuite.executeRegisteredTestSuites();
                } else {
                  throw new Error('executeRegisteredTestSuites not available. Ensure browser bundle is loaded.');
                }

                return freshMocha;
              },
            },
            (event) => {
              // Helper function to show hierarchical suite structure using shared function
              function showSuiteHierarchy(suiteHierarchy) {
                window.untpTestSuite.showSuiteHierarchy(
                  suiteHierarchy,
                  displayedSuites,
                  (suiteTitle, cleanTitle, tags, indentLevel) => {
                    appendResult(cleanTitle + tags, 'suite-title', indentLevel);
                  },
                );
              }

              // Stream results in real-time with formatting similar to CLI
              switch (event.type) {
                case 'start':
                  appendResult('üöÄ Running UNTP validation tests...');
                  displayedSuites.clear();
                  break;
                case 'pass':
                  showSuiteHierarchy(event.data.suiteHierarchy);
                  const testDuration = event.data.duration ? ` (${event.data.duration}ms)` : '';
                  const passIndent = event.data.suiteHierarchy.length;
                  const { cleanTitle: cleanTestTitle, tags: testTags } = window.untpTestSuite.formatTags(
                    event.data.title,
                  );
                  appendResult(`‚úî ${cleanTestTitle}${testTags}${testDuration}`, 'test-pass', passIndent);
                  break;
                case 'fail':
                  showSuiteHierarchy(event.data.suiteHierarchy);
                  const failIndent = event.data.suiteHierarchy.length;
                  const { cleanTitle: cleanFailTitle, tags: failTestTags } = window.untpTestSuite.formatTags(
                    event.data.title,
                  );
                  appendResult(`‚úñ ${cleanFailTitle}${failTestTags}`, 'test-fail', failIndent);
                  if (event.data.err && event.data.err.message) {
                    appendResult(event.data.err.message, 'test-error', failIndent + 1);
                  }
                  break;
                case 'pending':
                  showSuiteHierarchy(event.data.suiteHierarchy);
                  const pendingIndent = event.data.suiteHierarchy.length;
                  const { cleanTitle: cleanPendingTitle, tags: pendingTestTags } = window.untpTestSuite.formatTags(
                    event.data.title,
                  );
                  appendResult(`- ${cleanPendingTitle}${pendingTestTags}`, 'test-pending', pendingIndent);
                  break;
                case 'end':
                  const stats = event.data;
                  let summaryText = '';
                  if (stats.passes > 0) {
                    summaryText += `${stats.passes} passing`;
                  }
                  if (stats.failures > 0) {
                    if (summaryText) summaryText += ', ';
                    summaryText += `${stats.failures} failing`;
                  }
                  if (stats.pending > 0) {
                    if (summaryText) summaryText += ', ';
                    summaryText += `${stats.pending} pending`;
                  }
                  if (summaryText) {
                    summaryText += ` (${stats.duration || 0}ms)`;
                    appendResult(summaryText, 'summary');
                  }
                  break;
                default:
                  // Fallback for any other event types
                  appendResult(event.message || event.toString());
              }
            },
          );

          if (results.success) {
            showStatus('All tests passed! ‚úÖ', 'success');
          } else {
            showStatus(`Tests completed with ${results.stats.failures} failures`, 'error');
          }
        } catch (error) {
          console.error('Test execution error:', error);
          appendResult(`‚ùå Error: ${error.message}`);
          showStatus(`Test execution failed: ${error.message}`, 'error');
        } finally {
          isRunning = false;
          updateRunButton();
        }
      }

      // Initialize page
      document.addEventListener('DOMContentLoaded', () => {
        appendResult('UNTP Test Suite Browser Environment Ready');
        appendResult('Upload credential files to begin testing...');
      });
    </script>
  </body>
</html>
