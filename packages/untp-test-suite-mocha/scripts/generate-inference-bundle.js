#!/usr/bin/env node

/**
 * Generate Inference Bundle
 *
 * This script scans the inferences directory for .n3 files and generates
 * a TypeScript file with their contents embedded for browser use.
 * This allows the browser bundle to access inference rules without needing
 * Node.js filesystem modules.
 */

const fs = require('fs');
const path = require('path');

// Get the inferences directory path
const inferencesDir = path.join(__dirname, '../src/inferences');
const generatedDir = path.join(__dirname, '../src/generated');
const outputFile = path.join(generatedDir, 'inference-bundle.ts');

// Ensure generated directory exists
if (!fs.existsSync(generatedDir)) {
  fs.mkdirSync(generatedDir, { recursive: true });
}

try {
  // Read all files in the inferences directory
  const files = fs.readdirSync(inferencesDir);

  // Filter for .n3 files and sort them
  const inferenceFiles = files.filter((file) => file.endsWith('.n3')).sort();

  // Read the content of each file
  const fileContents = {};
  for (const file of inferenceFiles) {
    const filePath = path.join(inferencesDir, file);
    const content = fs.readFileSync(filePath, 'utf8');
    fileContents[file] = content;
  }

  // Generate the TypeScript content
  const content = `/**
 * Auto-generated Inference Bundle
 *
 * This file is automatically generated by scripts/generate-inference-bundle.js
 * Do not edit manually - it will be overwritten on build
 */

// Inference file contents for browser use
export const INFERENCE_FILES: Record<string, string> = ${JSON.stringify(fileContents, null, 2)};

// File list for Node.js compatibility
export const INFERENCE_FILE_LIST: string[] = ${JSON.stringify(inferenceFiles, null, 2)};
`;

  // Write the generated file
  fs.writeFileSync(outputFile, content, 'utf8');

  console.log(`Generated inference bundle with ${inferenceFiles.length} files:`);
  inferenceFiles.forEach((file) => console.log(`  - ${file}`));
  console.log(`Written to: ${path.relative(process.cwd(), outputFile)}`);
} catch (error) {
  console.error('Error generating inference bundle:', error);
  process.exit(1);
}
